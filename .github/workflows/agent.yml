name: CI Smart Agent

on:
  workflow_run:
    workflows: ["Django CI Pipeline"]   # ðŸ‘ˆ name of your main CI workflow
    types:
      - completed

jobs:
  analyze-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install agent dependencies
        run: |
          python -m pip install --upgrade pip
          pip install groq

      - name: Collect CI logs
        id: logs
        run: |
          echo "CI_LOGS<<EOF" >> $GITHUB_ENV
          echo "Workflow: ${{ github.event.workflow_run.name }}" >> $GITHUB_ENV
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}" >> $GITHUB_ENV
          echo "Run ID: ${{ github.event.workflow_run.id }}" >> $GITHUB_ENV
          echo "URL: ${{ github.event.workflow_run.html_url }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Run CI Smart Agent
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          CI_LOGS: ${{ env.CI_LOGS }}
        run: |
          python agent/agent.py
